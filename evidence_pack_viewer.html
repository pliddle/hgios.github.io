<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Evidence Pack Viewer</title>

    <!-- Loading both data sources -->
    <script src="tools/evidencepackdata.js"></script>
    <script src="tools/data.js"></script> 

    <!-- Added 'marked.js' library to convert Markdown to HTML -->
    <script src="https://cdn.jsdelivr.net/npm/marked/marked.min.js"></script>

    <style>
        /* --- Base & Typography --- */
        body {
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, Helvetica, Arial, sans-serif;
            background-color: #f9f9f9;
            color: #333;
            line-height: 1.6;
            margin: 0;
            padding: 0;
        }

        .container {
            max-width: 900px;
            margin: 20px auto;
            padding: 20px;
            background-color: #ffffff;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
        }

        /* --- Error Banner --- */
        #error-banner {
            display: none; 
            padding: 15px;
            background-color: #d9534f; 
            color: white;
            font-weight: bold;
            border-radius: 8px;
            margin-bottom: 15px;
            text-align: center;
        }

        /* --- Header Styling --- */
        .header-container {
            padding-bottom: 10px;
            border-bottom: 1px solid #eee;
            margin-bottom: 10px;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        .header-container img {
            height: 60px;
            width: auto; 
        }

        h1 {
            color: #1a1a1a;
            font-size: 2.2em;
            text-align: center;
            border-bottom: 2px solid #005a9c; 
            padding-bottom: 10px;
            margin-bottom: 15px;
        }

        h2 {
            color: #005a9c; 
            font-size: 1.6em;
            border-bottom: 1px solid #eee;
            padding-bottom: 8px;
            margin-top: 40px;
        }
        
        h3 {
            color: #333;
            font-size: 1.25em;
            margin-top: 25px;
        }

        p, ul {
            font-size: 1.05em;
            margin-bottom: 15px;
        }
        
        /* --- Rich text content styling --- */
        .text-content p {
            margin-top: 0;
            margin-bottom: 1em;
        }
        .text-content ul, .text-content ol {
            margin-bottom: 1em;
            padding-left: 30px;
        }
        .text-content li {
            margin-bottom: 0.5em;
        }

        /* --- Metadata Header --- */
        .pack-meta {
            display: flex;
            flex-wrap: wrap; 
            justify-content: space-between;
            align-items: center;
            gap: 20px;
            padding: 15px;
            background-color: #fdfdfd;
            border: 1px solid #eee;
            border-radius: 8px;
            margin-bottom: 30px;
        }

        /* --- QI Labels (HGIOS Colours) --- */
        .qi-labels {
            flex: 2; 
            min-width: 300px;
        }

        .qi-label {
            display: inline-block;
            padding: 8px 15px;
            border-radius: 20px; 
            font-size: 0.9em;
            font-weight: bold;
            color: #fff;
            margin-right: 10px;
            margin-bottom: 5px; 
            text-transform: uppercase;
            letter-spacing: 0.5px;
        }
        
        .qi-label:empty {
            display: none;
        }

        .qi-primary {
            background-color: #005a9c; 
        }

        .qi-secondary {
            background-color: #008a00; 
        }

        /* --- HGIOS 6-Point Scale --- */
        .impact-score {
            flex: 1;
            min-width: 220px; 
            text-align: right;
        }
        
        .impact-score strong {
            display: block;
            font-size: 0.9em;
            color: #555;
            margin-bottom: 5px;
            text-transform: uppercase;
            font-weight: bold;
        }

        .impact-meter {
            display: flex;
            gap: 5px;
            justify-content: flex-end; 
        }

        .impact-block {
            width: 30px; 
            height: 15px;
            border-radius: 3px;
            background-color: #e0e0e0; 
            border: 1px solid #ccc;
        }

        /* HGIOS Progressive Grade Colours */
        .hgios-1-unsatisfactory { background-color: #d9534f; border-color: #b0413e; } 
        .hgios-2-weak { background-color: #E67E22; border-color: #C0392B; } 
        .hgios-3-satisfactory { background-color: #f7d94c; border-color: #c08a3e; } 
        .hgios-4-good { background-color: #5cb85c; border-color: #4a944a; } 
        .hgios-5-verygood { background-color: #008a00; border-color: #006b00; } 
        .hgios-6-excellent { background-color: #005a9c; border-color: #004475; } 


        /* --- Section Styling --- */
        section {
            margin-bottom: 30px;
        }

        /* --- Quantitative Boxes --- */
        .quant-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(250px, 1fr));
            gap: 20px;
            margin-top: 20px;
        }

        .quant-box {
            background-color: #005a9c; 
            color: #ffffff;
            padding: 20px;
            border-radius: 10px;
            text-align: center;
            font-size: 1.1em;
            font-weight: bold;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.1);
        }
        
        .impact-box {
            background-color: #008a00; 
        }
        
        /* Qualitative Speech Bubbles */
        .qual-container {
            margin-top: 20px;
        }

        .speech-bubble {
            background: #f4f8fb; 
            border-left: 5px solid #005a9c; 
            padding: 15px 20px;
            margin-bottom: 15px;
            border-radius: 0 5px 5px 0;
            font-style: italic;
            font-size: 1.05em;
            position: relative;
        }

        .speech-bubble::before {
            content: 'â€œ';
            font-size: 3em;
            color: #005a9c;
            opacity: 0.2;
            position: absolute;
            top: -10px;
            left: 5px;
        }
        
        /* --- Embedded Media Styling --- */
        .embedded-media-container {
            margin: 25px auto;
            max-width: 90%;
            border: 1px solid #eee;
            border-radius: 8px;
            box-shadow: 0 4px 12px rgba(0, 0, 0, 0.05);
            background: #fdfdfd;
            overflow: hidden; 
            cursor: pointer; /* Indicate clickability */
        }
        .embedded-media-img {
            width: 100%;
            height: auto;
            display: block;
        }
        .embedded-media-iframe {
            width: 100%;
            height: 500px;
            border: none;
            display: block;
        }
        .embedded-media-caption {
            padding: 10px 15px;
            font-size: 0.9em;
            font-style: italic;
            color: #555;
            text-align: center;
            margin: 0;
            border-top: 1px solid #eee;
        }
        .embedded-media-container p:last-child {
            margin-bottom: 0; 
        }

        /* --- VISUAL EVIDENCE STYLING (Grid & Carousel) --- */
        #visual-evidence {
            display: none; 
        }

        /* View Mode Toggle */
        .view-mode-controls {
            display: flex;
            justify-content: flex-end;
            margin-bottom: 10px;
            gap: 10px;
        }
        .view-mode-btn {
            padding: 5px 10px;
            border: 1px solid #ccc;
            background: #f9f9f9;
            cursor: pointer;
            border-radius: 4px;
            font-size: 0.9em;
        }
        .view-mode-btn.active {
            background: #005a9c;
            color: white;
            border-color: #005a9c;
        }

        /* Grid View */
        .visual-grid {
            display: grid;
            grid-template-columns: repeat(auto-fit, minmax(200px, 1fr));
            gap: 15px;
            margin-top: 20px;
        }
        .visual-card {
            display: block;
            background-color: #fff;
            border: 1px solid #eee;
            border-radius: 8px;
            text-decoration: none;
            color: #333;
            font-weight: 500;
            transition: all 0.2s ease;
            overflow: hidden; 
            cursor: pointer;
        }
        .visual-card:hover {
            border-color: #005a9c;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05);
        }
        .visual-card-img {
            width: 100%;
            height: 150px;
            object-fit: cover;
            display: block;
            background-color: #f4f8fb;
            color: #777;
            font-size: 12px;
            text-align: center;
        }
        .visual-card-title {
            display: block;
            padding: 10px 15px;
            font-size: 0.9em;
            font-weight: 500;
            text-align: center;
            background-color: #fdfdfd;
            border-top: 1px solid #eee;
            white-space: nowrap;
            overflow: hidden;
            text-overflow: ellipsis;
        }

        /* Carousel View */
        .visual-carousel {
            display: none; /* Hidden by default */
            position: relative;
            background: #f0f0f0;
            border-radius: 8px;
            overflow: hidden;
            text-align: center;
        }
        .carousel-slide {
            display: none;
            padding: 20px;
        }
        .carousel-slide.active {
            display: block;
        }
        .carousel-img {
            max-width: 100%;
            max-height: 400px;
            margin: 0 auto;
            display: block;
            box-shadow: 0 2px 8px rgba(0,0,0,0.1);
            border-radius: 4px;
            cursor: pointer;
        }
        .carousel-caption {
            margin-top: 10px;
            font-style: italic;
            color: #555;
        }
        .carousel-controls {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 10px 20px;
            background: #eee;
            border-top: 1px solid #ddd;
        }
        .carousel-btn {
            background: #005a9c;
            color: white;
            border: none;
            padding: 8px 15px;
            border-radius: 4px;
            cursor: pointer;
        }
        .carousel-btn:disabled {
            background: #ccc;
            cursor: default;
        }
        .carousel-counter {
            font-size: 0.9em;
            color: #777;
            font-weight: bold;
        }

        /* --- NEW: Image Viewer Modal (Lightbox) --- */
        .modal {
            display: none; 
            position: fixed; 
            z-index: 1000; 
            padding-top: 50px; 
            left: 0;
            top: 0;
            width: 100%; 
            height: 100%; 
            overflow: auto; 
            background-color: rgb(0,0,0); 
            background-color: rgba(0,0,0,0.9); 
        }

        .modal-content {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 1000px;
            max-height: 80vh;
            object-fit: contain;
            background-color: white;
        }

        .modal-caption {
            margin: auto;
            display: block;
            width: 80%;
            max-width: 700px;
            text-align: center;
            color: #ccc;
            padding: 10px 0;
            height: 150px;
        }

        .close-modal {
            position: absolute;
            top: 15px;
            right: 35px;
            color: #f1f1f1;
            font-size: 40px;
            font-weight: bold;
            transition: 0.3s;
            cursor: pointer;
        }

        .close-modal:hover,
        .close-modal:focus {
            color: #bbb;
            text-decoration: none;
            cursor: pointer;
        }


        /* --- Evidence Table Styles --- */
        .evidence-table-container {
            overflow-x: auto;
            background-color: #fff; 
            padding: 15px; 
            border-radius: 8px; 
            box-shadow: 0 2px 8px rgba(0,0,0,0.05); 
        }
        
        .evidence-table {
            width: 100%;
            border-collapse: collapse;
            font-size: 13px; 
            margin-top: 0; 
        }
        .evidence-table th, .evidence-table td {
            padding: 8px 10px; 
            text-align: left;
            border-bottom: 1px solid #ddd;
            word-break: break-word;
            vertical-align: top;
        }
        .evidence-table th {
            background-color: #f9f9f9;
            font-weight: 600;
            color: #333;
        }
        .evidence-table tr:hover {
            background-color: #f4f8fb;
        }
        .evidence-table td a {
            font-weight: 600;
            color: #005a9c;
            text-decoration: none;
        }
        .evidence-table td a:hover {
            text-decoration: underline;
        }
        /* Column widths */
        .evidence-table th:nth-child(1) { width: 25%; } /* Name */
        .evidence-table th:nth-child(2) { width: 10%; } /* QIs */
        .evidence-table th:nth-child(3) { width: 15%; } /* Tags */
        .evidence-table th:nth-child(4) { width: 30%; } /* Description */
        .evidence-table th:nth-child(5) { width: 10%; } /* Session */
        .evidence-table th:nth-child(6) { width: 10%; } /* Status */
        
        .table-qi-label {
            display: inline-block;
            padding: 3px 10px; 
            font-size: 11px; 
            font-weight: bold;
            color: #fff;
            background-color: #005a9c; /* HGIOS Blue */
            border-radius: 15px;
            margin-bottom: 3px; 
            margin-right: 3px;
            cursor: default; 
        }

        
        /* --- Print Button --- */
        @media print {
            body {
                background-color: #fff;
                box-shadow: none;
                margin: 0;
                padding: 0;
            }
            .container {
                box-shadow: none;
                margin: 0;
                max-width: 100%;
            }
            .print-button, .header-container, #error-banner, .view-mode-controls, .modal {
                display: none;
            }
            .embedded-media-iframe {
                display: none; 
            }
            .embedded-media-container {
                page-break-inside: avoid;
            }
            h1 {
                font-size: 2em;
            }
            /* Force grid view for print */
            .visual-carousel { display: none !important; }
            .visual-grid { display: grid !important; }
        }

        .print-button {
            display: block;
            width: 100%;
            padding: 15px;
            background-color: #005a9c;
            color: #fff;
            text-align: center;
            text-decoration: none;
            font-size: 1.2em;
            font-weight: bold;
            border: none;
            border-radius: 8px;
            cursor: pointer;
            margin-top: 20px;
        }
        .print-button:hover {
            background-color: #004475;
        }

    </style>
</head>
<body>

    <div class="container">
        
        <!-- ERROR BANNER -->
        <div id="error-banner"></div>

        <!-- HEADER -->
        <div class="header-container">
            <img src="image/badge.png" alt="School Logo" class="header-image" onerror="this.src='https://placehold.co/150x60/eee/ccc?text=School+Logo'" >
            <img src="image/values.png" alt="Council Logo" class="header-image" onerror="this.src='https://placehold.co/150x60/eee/ccc?text=Council+Logo'">
        </div>

        <!-- TITLE & META -->
        <h1 id="pack-title">Loading...</h1>

        <div class="pack-meta">
            <div class="qi-labels">
                <span class="qi-label qi-primary" id="primary-qi"></span>
                <span class="qi-label qi-secondary" id="secondary-qi"></span>
            </div>
            <div class="impact-score">
                <strong id="hgios-rating-text"></strong>
                <div class="impact-meter" id="hgios-meter">
                    <!-- This will be generated by JavaScript -->
                </div>
            </div>
        </div>
        
        <!-- VISUAL EVIDENCE -->
        <section id="visual-evidence">
            <h2>Visual Evidence</h2>
            
            <!-- Mode Switcher -->
            <div class="view-mode-controls">
                <button class="view-mode-btn active" id="btn-grid-view" onclick="switchView('grid')">Grid View</button>
                <button class="view-mode-btn" id="btn-carousel-view" onclick="switchView('carousel')">Carousel View</button>
            </div>

            <!-- Grid View -->
            <div class="visual-grid" id="visual-evidence-grid"></div>

            <!-- Carousel View -->
            <div class="visual-carousel" id="visual-evidence-carousel">
                <div id="carousel-slides-container">
                    <!-- Slides injected here -->
                </div>
                <div class="carousel-controls">
                    <button class="carousel-btn" onclick="moveCarousel(-1)">Previous</button>
                    <span class="carousel-counter" id="carousel-counter">1 of 5</span>
                    <button class="carousel-btn" onclick="moveCarousel(1)">Next</button>
                </div>
            </div>
        </section>

        <!-- WHAT -->
        <section id="what">
            <h2>What: Our Practice & Evidence</h2>
            <div id="what-text" class="text-content"></div> 
            
            <!-- Updated heading ID for JS control -->
            <h3 id="participation-heading">Participation Summary</h3>
            <div class="quant-grid" id="participation-grid"></div>
        </section>

        <!-- SO WHAT -->
        <section id="so-what">
            <h2>So What: The Impact & Outcomes</h2>
            <div id="so-what-text" class="text-content"></div>
            
            <!-- UPDATED: Added ID for JS control -->
            <h3 id="impact-heading">Quantitative Summary (Impact)</h3>
            <div class="quant-grid" id="impact-grid"></div>
            
            <!-- UPDATED: Added ID for JS control -->
            <h3 id="qualitative-heading">Qualitative Summary</h3>
            <div class="qual-container" id="qualitative-bubbles"></div>
        </section>

        <!-- WHAT NOW -->
        <section id="what-now">
            <h2>What Now: The Next Steps</h2>
            <div id="what-now-text" class="text-content"></div>
        </section>

        <!-- COLLATED EVIDENCE TABLE -->
        <section id="evidence">
            <h2>Collated Evidence Files</h2>
            <p>The following files from the Evidence Library are tagged with this Evidence Pack:</p>
            <div class="evidence-table-container">
                <table class="evidence-table">
                    <thead>
                        <tr>
                            <th>Name</th>
                            <th>QIs</th>
                            <th>Tags</th>
                            <th>Description</th>
                            <th>Session(s)</th>
                            <th>Status</th>
                        </tr>
                    </thead>
                    <tbody id="pack-evidence-table-body">
                        <!-- Populated by JS -->
                    </tbody>
                </table>
            </div>
        </section>

        <button class="print-button" onclick="window.print()">Print / Save as PDF</button>
    </div>

    <!-- IMAGE MODAL -->
    <div id="image-modal" class="modal">
        <span class="close-modal" onclick="closeModal()">&times;</span>
        <img class="modal-content" id="modal-image">
        <div class="modal-caption" id="modal-caption"></div>
    </div>

    <!-- JAVASCRIPT LOGIC -->
    <script>
        // --- Global State for Carousel ---
        let currentSlideIndex = 0;
        let totalSlides = 0;
        
        // --- DATA LOADING & INITIALIZATION ---
        const files = (typeof myFiles !== 'undefined') ? myFiles : [];
        const packs = (typeof evidencePacks !== 'undefined') ? evidencePacks : [];

        const hgiosText = { 1: "Unsatisfactory", 2: "Weak", 3: "Satisfactory", 4: "Good", 5: "Very Good", 6: "Excellent" };
        const hgiosClasses = ["hgios-1-unsatisfactory", "hgios-2-weak", "hgios-3-satisfactory", "hgios-4-good", "hgios-5-verygood", "hgios-6-excellent"];

        // --- HELPER FUNCTIONS ---
        
        function formatMarkdown(text, allFiles) {
            const usedImages = new Set();
            if (!text) return { html: "", usedImages };
            
            const embeds = [];
            const shortcodeRegex = /\[(image):\s*([^\]]+)\]/gi; 
            
            let processedText = text.replace(shortcodeRegex, (match, type, filename) => {
                const trimmedFilename = filename.trim();
                usedImages.add(trimmedFilename);
                const fileItem = allFiles.find(f => f.Name === trimmedFilename);
                
                let html = "";
                if (fileItem) {
                    html = buildImageEmbed(fileItem);
                } else {
                    html = `<p style="color:red; font-weight:bold;">[File not found: ${trimmedFilename}]</p>`;
                }
                embeds.push(html);
                return `<!--EMBED_${embeds.length - 1}-->`;
            });

            let markdownHtml = marked.parse(processedText, { breaks: true });

            for (let i = embeds.length - 1; i >= 0; i--) {
                const token = `<!--EMBED_${i}-->`;
                markdownHtml = markdownHtml.replace(new RegExp(`<p>${token}</p>`, 'g'), embeds[i]);
                markdownHtml = markdownHtml.replace(new RegExp(token, 'g'), embeds[i]);
            }
            return { html: markdownHtml, usedImages };
        }
        
        // UPDATED: buildImageEmbed with onclick handler for modal
        function buildImageEmbed(item) {
            const placeholderText = 'Please log in to%0ASharePoint%0Ato view image';
            const placeholderUrl = `https://placehold.co/600x400/f4f8fb/777?text=${placeholderText}`;
            const onErrorScript = `this.src='${placeholderUrl}'; this.onerror=null;`;
            let caption = item.EvidenceDescription ? item.EvidenceDescription : item.Name;
            const captionHtml = marked.parse(caption, { breaks: true });
            
            // Escape single quotes for the onclick handler
            const safeUrl = item.Link.replace(/'/g, "\\'");
            const safeCaption = captionHtml.replace(/'/g, "\\'").replace(/"/g, '&quot;');

            return `
                <div class="embedded-media-container" onclick="openModal('${safeUrl}', '${safeCaption}')">
                    <img src="${item.Link}" alt="${item.Name}" class="embedded-media-img" onerror="${onErrorScript}">
                    <div class="embedded-media-caption">${captionHtml}</div>
                </div>
            `;
        }

        function buildHgiosMeter(score) {
            let meterHtml = "";
            for (let i = 0; i < 6; i++) {
                meterHtml += `<span class="impact-block ${i < score ? hgiosClasses[i] : ''}"></span>`;
            }
            return meterHtml;
        }

        function buildHtmlList(items, itemType, allFiles) {
            let html = "";
            const usedImages = new Set();
            // Check if items exist and are not just empty strings
            if (!items || items.length === 0) return { html: "", usedImages }; 
            
            let hasContent = false;

            switch (itemType) {
                case 'quant-box':
                    items.forEach(item => { 
                        if(item && item.trim() !== "") {
                            html += `<div class="quant-box">${item}</div>`;
                            hasContent = true;
                        }
                    });
                    break;
                case 'impact-box': 
                     items.forEach(item => { 
                        if(item && item.trim() !== "") {
                            html += `<div class="quant-box impact-box">${item}</div>`; 
                            hasContent = true;
                        }
                    });
                    break;
                case 'speech-bubble':
                    items.forEach(item => {
                        if(item && item.trim() !== "") {
                            const result = formatMarkdown(item, allFiles);
                            html += `<div class="speech-bubble">${result.html}</div>`; 
                            result.usedImages.forEach(img => usedImages.add(img));
                            hasContent = true;
                        }
                    });
                    break;
            }
            
            if (!hasContent) html = "";
            
            return { html, usedImages };
        }
        
        function setTextOrHide(element, text) {
            if (element) {
                if (text && text.trim() !== "") {
                    element.textContent = text;
                    element.style.display = 'inline-block';
                } else {
                    element.style.display = 'none';
                }
            }
        }
        
        function formatAndSetText(elementId, text, allFiles) {
            const element = document.getElementById(elementId);
            if (element) {
                const result = formatMarkdown(text, allFiles);
                element.innerHTML = result.html;
                return result.usedImages;
            }
            return new Set();
        }

        function populateEvidenceTable(packTitle, allFiles) {
            const tableBody = document.getElementById('pack-evidence-table-body');
            if (!tableBody) return;

            const matchingFiles = allFiles.filter(file => 
            (file["Evidence Pack Name"] || "").split(/[;,]\s*/).includes(packTitle) &&
                (!file.ItemType || file.ItemType.toLowerCase() !== 'folder') &&
                (file.QIs && file.QIs.trim() !== '') 
            );

            if (matchingFiles.length === 0) {
                tableBody.innerHTML = '<tr><td colspan="6">No associated files found in the library.</td></tr>';
                return;
            }

            let tableHtml = "";
            matchingFiles.forEach(item => {
                let qiHtml = 'N/A';
                if (item.QIs) {
                    const qis = item.QIs.split(';').map(qi => qi.replace(/#/g, '').trim()).filter(qi => qi); 
                    if (qis.length > 0) {
                        qiHtml = qis.map(qi => {
                            const qiCodeMatch = qi.match(/^([0-9.]+)/); 
                            const qiCode = qiCodeMatch ? qiCodeMatch[1] : qi;
                            return `<span class="table-qi-label" title="${qi}">${qiCode}</span>`; 
                        }).join(' ');
                    }
                }
                const cleanSessions = item.Session ? item.Session.replace(/#/g, '') : 'N/A';
                const result = formatMarkdown(item.EvidenceDescription || 'N/A', allFiles);

                tableHtml += `
                    <tr>
                        <td><a href="${item.Link}" target="_blank">${item.Name}</a></td>
                        <td>${qiHtml}</td>
                        <td>${item.Tags || 'N/A'}</td>
                        <td class="description-cell">${result.html}</td> 
                        <td>${cleanSessions}</td>
                        <td>${item.Status || 'N/A'}</td>
                    </tr>
                `;
            });
            tableBody.innerHTML = tableHtml;
        }
        
        // --- Visual Evidence Logic (Grid + Carousel) ---
        function populateVisualEvidence(packTitle, allFiles, usedImages) {
            const gridContainer = document.getElementById('visual-evidence-grid');
            const carouselContainer = document.getElementById('carousel-slides-container');
            const section = document.getElementById('visual-evidence');
            const imageExtensions = ['.png', '.jpg', '.jpeg', '.gif', '.bmp', '.svg'];

            if (!gridContainer || !section) return;

            const matchingImages = allFiles.filter(file => {
                const nameLower = file.Name.toLowerCase();
                const isImage = imageExtensions.some(ext => nameLower.endsWith(ext));
                const isUsed = usedImages.has(file.Name);
                return (file["Evidence Pack Name"] || "").split(/[;,]\s*/).includes(packTitle) && isImage &&
                       (!file.ItemType || file.ItemType.toLowerCase() !== 'folder') &&
                       !isUsed;
            });

            if (matchingImages.length === 0) {
                section.style.display = 'none';
                return;
            }
            
            section.style.display = 'block';
            totalSlides = matchingImages.length;

            let gridHtml = "";
            let carouselHtml = "";
            
            const placeholderText = 'Please log in to%0ASharePoint%0Ato view image';
            const placeholderUrl = `https://placehold.co/600x400/f4f8fb/777?text=${placeholderText}`;
            const onErrorScript = `this.src='${placeholderUrl}'; this.onerror=null;`;

            matchingImages.forEach((item, idx) => {
                // Escape strings for onclick
                const safeUrl = item.Link.replace(/'/g, "\\'");
                const safeName = item.Name.replace(/'/g, "\\'");

                // Grid Item (Updated to use onclick for modal)
                gridHtml += `
                    <div class="visual-card" onclick="openModal('${safeUrl}', '${safeName}')">
                        <img src="${item.Link}" alt="${item.Name}" class="visual-card-img" onerror="${onErrorScript}">
                        <span class="visual-card-title">${item.Name}</span>
                    </div>
                `;
                
                // Carousel Item (Updated to use onclick for modal)
                const activeClass = (idx === 0) ? 'active' : '';
                carouselHtml += `
                    <div class="carousel-slide ${activeClass}" data-index="${idx}">
                        <div onclick="openModal('${safeUrl}', '${safeName}')">
                            <img src="${item.Link}" alt="${item.Name}" class="carousel-img" onerror="${onErrorScript}">
                        </div>
                        <div class="carousel-caption">${item.Name}</div>
                    </div>
                `;
            });
            
            gridContainer.innerHTML = gridHtml;
            carouselContainer.innerHTML = carouselHtml;
            updateCarouselUI();
        }

        // --- MODAL FUNCTIONS ---
        function openModal(url, caption) {
            const modal = document.getElementById('image-modal');
            const modalImg = document.getElementById('modal-image');
            const modalCaption = document.getElementById('modal-caption');
            
            modal.style.display = "block";
            modalImg.src = url;
            
            // Apply error handling to modal image too
            const placeholderText = 'Please log in to%0ASharePoint%0Ato view image';
            const placeholderUrl = `https://placehold.co/800x600/f4f8fb/777?text=${placeholderText}`;
            modalImg.onerror = function() { this.src = placeholderUrl; this.onerror = null; };
            
            modalCaption.innerHTML = caption;
        }

        function closeModal() {
            document.getElementById('image-modal').style.display = "none";
        }
        
        // Close modal if clicking outside image
        window.onclick = function(event) {
            const modal = document.getElementById('image-modal');
            if (event.target == modal) {
                modal.style.display = "none";
            }
        }


        // --- UI INTERACTION FUNCTIONS ---

        function switchView(mode) {
            const grid = document.getElementById('visual-evidence-grid');
            const carousel = document.getElementById('visual-evidence-carousel');
            const btnGrid = document.getElementById('btn-grid-view');
            const btnCarousel = document.getElementById('btn-carousel-view');

            if (mode === 'grid') {
                grid.style.display = 'grid';
                carousel.style.display = 'none';
                btnGrid.classList.add('active');
                btnCarousel.classList.remove('active');
            } else {
                grid.style.display = 'none';
                carousel.style.display = 'block';
                btnGrid.classList.remove('active');
                btnCarousel.classList.add('active');
            }
        }

        function moveCarousel(direction) {
            const slides = document.querySelectorAll('.carousel-slide');
            if (slides.length === 0) return;
            
            // Hide current
            slides[currentSlideIndex].classList.remove('active');
            
            // Calculate new index
            currentSlideIndex += direction;
            if (currentSlideIndex < 0) currentSlideIndex = totalSlides - 1;
            if (currentSlideIndex >= totalSlides) currentSlideIndex = 0;
            
            // Show new
            slides[currentSlideIndex].classList.add('active');
            updateCarouselUI();
        }
        
        function updateCarouselUI() {
            const counter = document.getElementById('carousel-counter');
            if(counter) counter.textContent = `${currentSlideIndex + 1} of ${totalSlides}`;
        }

        // --- MAIN LOAD FUNCTION ---
        window.onload = function() {
            let index = 0;
            try {
                const urlParams = new URLSearchParams(window.location.search);
                index = parseInt(urlParams.get('index'), 10) || 0;
            } catch (e) { index = 0; }

            let packData; 
            if (packs.length > 0) {
                 packData = packs.find(p => p.id === index) || packs[0];
            } else {
                const banner = document.getElementById('error-banner');
                if (banner) { banner.style.display = 'block'; banner.textContent = "No Data Found."; }
                return;
            }

            try {
                document.title = packData.title;
                document.getElementById('pack-title').textContent = packData.title;
                setTextOrHide(document.getElementById('primary-qi'), packData.primary_qi);
                setTextOrHide(document.getElementById('secondary-qi'), packData.secondary_qi);
                
                const score = parseInt(packData.hgios_score, 10);
                if (!isNaN(score)) {
                    document.getElementById('hgios-rating-text').textContent = `Self-Evaluation: ${score} - ${hgiosText[score]}`;
                    document.getElementById('hgios-meter').innerHTML = buildHgiosMeter(score);
                }

                // --- Track used images ---
                const allUsedImages = new Set();

                const whatRes = formatAndSetText('what-text', packData.what_text, files);
                whatRes.forEach(i => allUsedImages.add(i));
                
                // --- PARTICIPATION SUMMARY LOGIC ---
                const partResult = buildHtmlList(packData.participation_summary, 'quant-box', files);
                const partGrid = document.getElementById('participation-grid');
                const partHead = document.getElementById('participation-heading');

                if (!partResult.html || partResult.html.trim() === "") {
                    partGrid.style.display = 'none';
                    if (partHead) partHead.style.display = 'none';
                } else {
                    partGrid.innerHTML = partResult.html;
                    partGrid.style.display = 'grid';
                    if (partHead) partHead.style.display = 'block';
                }

                const soWhatRes = formatAndSetText('so-what-text', packData.so_what_text, files);
                soWhatRes.forEach(i => allUsedImages.add(i));
                
                // --- UPDATED: IMPACT SUMMARY LOGIC ---
                const impResult = buildHtmlList(packData.impact_summary, 'impact-box');
                const impGrid = document.getElementById('impact-grid');
                const impHead = document.getElementById('impact-heading');

                if (!impResult.html || impResult.html.trim() === "") {
                    impGrid.style.display = 'none';
                    if (impHead) impHead.style.display = 'none';
                } else {
                    impGrid.innerHTML = impResult.html;
                    impGrid.style.display = 'grid';
                    if (impHead) impHead.style.display = 'block';
                }
                
                // --- UPDATED: QUALITATIVE SUMMARY LOGIC ---
                const qualResult = buildHtmlList(packData.qualitative_summary, 'speech-bubble', files);
                const qualContainer = document.getElementById('qualitative-bubbles');
                const qualHead = document.getElementById('qualitative-heading');
                
                if (!qualResult.html || qualResult.html.trim() === "") {
                    qualContainer.style.display = 'none';
                    if (qualHead) qualHead.style.display = 'none';
                } else {
                    qualContainer.innerHTML = qualResult.html;
                    qualContainer.style.display = 'block';
                    if (qualHead) qualHead.style.display = 'block';
                }
                
                qualResult.usedImages.forEach(i => allUsedImages.add(i));

                const whatNowRes = formatAndSetText('what-now-text', packData.what_now_steps, files);
                whatNowRes.forEach(i => allUsedImages.add(i));
                
                // --- Populate Visual Evidence ---
                populateVisualEvidence(packData.title, files, allUsedImages);
                
                // --- Populate Table ---
                populateEvidenceTable(packData.title, files);

            } catch (error) {
                console.error("Error:", error);
            }
        };
    </script>
</body>
</html>