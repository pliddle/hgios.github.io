<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>HGIOS 4 Interactive Evaluation Tool</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
    <script src="https://cdnjs.cloudflare.com/ajax/libs/Chart.js/3.9.1/chart.min.js"></script>
    
    <!-- 
      AUTO-LOAD MECHANISM:
      The tool attempts to load 'default.js' from the same directory.
      If found, it sets window.HGIOS_SAVED_DATA.
      If not found, this script tag fails silently (check console for 404), 
      and the app falls back to localStorage.
    -->
    <script src="default.js"></script>

    <style>
        @import url('https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap');
        body { font-family: 'Inter', sans-serif; }
        
        /* Interactive Cells */
        .cell-interactive { transition: all 0.2s ease; cursor: pointer; }
        .cell-interactive:hover { transform: translateY(-2px); box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); }
        .selected-secure { background-color: #dcfce7 !important; border-left: 4px solid #22c55e !important; }
        .selected-partial { background-color: #ffedd5 !important; border-left: 4px solid #f97316 !important; }
        
        .animate-pop { animation: pop 0.3s ease-out; }
        @keyframes pop {
            0% { transform: scale(0.95); }
            50% { transform: scale(1.02); }
            100% { transform: scale(1); }
        }
        
        /* Dashboard Styles */
        .dash-card { transition: transform 0.3s ease, box-shadow 0.3s ease; }
        .dash-card:hover { transform: translateY(-5px); box-shadow: 0 10px 15px -3px rgba(0, 0, 0, 0.1), 0 4px 6px -2px rgba(0, 0, 0, 0.05); }
        .bg-level-4 { background: linear-gradient(135deg, #fffbeb 0%, #fef3c7 100%); border-color: #fbbf24; color: #92400e; }
        .bg-level-5 { background: linear-gradient(135deg, #eff6ff 0%, #dbeafe 100%); border-color: #3b82f6; color: #1e40af; }
        .bg-level-6 { background: linear-gradient(135deg, #faf5ff 0%, #f3e8ff 100%); border-color: #a855f7; color: #6b21a8; }
        .bg-level-0 { background: #f8fafc; border-color: #e2e8f0; color: #64748b; }

        /* --- PRINT STYLES --- */
        @media print {
            @page { size: landscape; margin: 1cm; }
            
            /* Hide UI elements */
            header, aside, #toggle-btn, .qi-btn, button { display: none !important; }
            
            /* Reset Layout Constraints */
            body, html, #edit-view, #rubric-container, #dashboard-view {
                height: auto !important;
                overflow: visible !important;
                position: static !important;
                background: white !important;
            }

            /* Logic for printing Dashboard vs Edit View */
            body.printing-dashboard #edit-view { display: none !important; }
            body.printing-dashboard #dashboard-view { 
                display: block !important; 
                position: relative !important; 
                inset: auto !important; 
                padding: 0 !important;
                background: white !important;
            }

            /* Ensure Background Colors Print */
            * { -webkit-print-color-adjust: exact !important; print-color-adjust: exact !important; }
            
            /* Canvas Sizing */
            canvas { max-width: 100% !important; max-height: 400px !important; }
            
            /* Break Pages Nicely */
            .dash-card { break-inside: avoid; page-break-inside: avoid; border: 1px solid #ccc !important; box-shadow: none !important; }
            h2 { color: #1e3a8a !important; }
        }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 h-screen flex flex-col overflow-hidden">

    <!-- Hidden Input for Loading Files -->
    <input type="file" id="file-upload" class="hidden" accept=".js,.json" onchange="handleFileUpload(this)">

    <!-- Header -->
    <header class="bg-blue-900 text-white p-4 shadow-lg shrink-0 z-30 relative">
        <div class="container mx-auto flex justify-between items-center">
            <div>
                <h1 class="text-2xl font-bold tracking-tight">HGIOS 4 Evaluation Toolkit</h1>
                <p class="text-blue-200 text-sm">Secondary School Framework (Sector-Leading Benchmarks)</p>
            </div>
            <div class="flex space-x-3">
                <button onclick="saveProfile()" class="px-3 py-2 bg-blue-800 hover:bg-blue-700 rounded text-sm font-medium transition border border-blue-700" title="Save as JS file">
                    <i class="fa-solid fa-download mr-2"></i>Save
                </button>
                <button onclick="triggerLoad()" class="px-3 py-2 bg-blue-800 hover:bg-blue-700 rounded text-sm font-medium transition border border-blue-700" title="Load JS/JSON file">
                    <i class="fa-solid fa-upload mr-2"></i>Load
                </button>
                <div class="w-px h-8 bg-blue-700 mx-1"></div>
                <button onclick="resetAll()" class="px-3 py-2 bg-blue-800 hover:bg-blue-700 rounded text-sm font-medium transition" title="Clear all data">
                    <i class="fa-solid fa-rotate-right"></i>
                </button>
                <button onclick="toggleDashboard()" id="toggle-btn" class="px-4 py-2 bg-white text-blue-900 hover:bg-blue-50 rounded text-sm font-bold shadow transition flex items-center">
                    <i class="fa-solid fa-chart-pie mr-2"></i> Visualise Dashboard
                </button>
            </div>
        </div>
    </header>

    <!-- Main Content Area (Edit Mode) -->
    <div id="edit-view" class="flex flex-1 overflow-hidden transition-opacity duration-300 opacity-100">
        
        <!-- Sidebar: QI Selector -->
        <aside class="w-64 bg-white border-r border-slate-200 overflow-y-auto shrink-0 z-10 print:hidden">
            <nav class="p-4 space-y-2">
                <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider mb-2">Leadership & Management</div>
                <button onclick="loadQI('1.3')" id="nav-1.3" class="qi-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 focus:outline-none transition flex justify-between items-center group">
                    <span>1.3 Leadership of Change</span>
                    <span class="status-dot w-2 h-2 rounded-full bg-slate-300 group-hover:bg-slate-400"></span>
                </button>

                <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider mt-6 mb-2">Learning Provision</div>
                <button onclick="loadQI('2.2')" id="nav-2.2" class="qi-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 focus:outline-none transition flex justify-between items-center group">
                    <span>2.2 Curriculum</span>
                    <span class="status-dot w-2 h-2 rounded-full bg-slate-300 group-hover:bg-slate-400"></span>
                </button>
                <button onclick="loadQI('2.3')" id="nav-2.3" class="qi-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 focus:outline-none transition flex justify-between items-center group">
                    <span>2.3 Learning, Teaching & Assessment</span>
                    <span class="status-dot w-2 h-2 rounded-full bg-slate-300 group-hover:bg-slate-400"></span>
                </button>

                <div class="text-xs font-semibold text-slate-400 uppercase tracking-wider mt-6 mb-2">Successes & Achievements</div>
                <button onclick="loadQI('3.1')" id="nav-3.1" class="qi-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 focus:outline-none transition flex justify-between items-center group">
                    <span>3.1 Wellbeing, Equality & Inclusion</span>
                    <span class="status-dot w-2 h-2 rounded-full bg-slate-300 group-hover:bg-slate-400"></span>
                </button>
                <button onclick="loadQI('3.2')" id="nav-3.2" class="qi-btn w-full text-left px-4 py-3 rounded-lg hover:bg-slate-100 focus:outline-none transition flex justify-between items-center group">
                    <span>3.2 Raising Attainment</span>
                    <span class="status-dot w-2 h-2 rounded-full bg-slate-300 group-hover:bg-slate-400"></span>
                </button>
            </nav>
        </aside>

        <!-- Main Workspace -->
        <main class="flex-1 flex flex-col overflow-hidden relative bg-slate-50">
            
            <!-- Dashboard / Stats Bar -->
            <div class="bg-white border-b border-slate-200 p-4 flex items-center justify-between shrink-0 shadow-sm z-20">
                <div>
                    <h2 id="current-qi-title" class="text-xl font-bold text-slate-800">Select a Quality Indicator</h2>
                    <p class="text-sm text-slate-500">Click cells to highlight evidence. Click once for <span class="font-bold text-green-600">Secure (Green)</span>, twice for <span class="font-bold text-orange-500">Partial (Orange)</span>.</p>
                </div>
                <div class="flex items-center gap-4">
                    <div class="text-right">
                        <div class="text-xs font-medium text-slate-400 uppercase">Active QI Profile</div>
                        <div class="flex items-end gap-1 h-8 w-32">
                            <div id="bar-4" class="bg-amber-400 w-1/3 rounded-t transition-all duration-500" style="height: 0%;"></div>
                            <div id="bar-5" class="bg-blue-500 w-1/3 rounded-t transition-all duration-500" style="height: 0%;"></div>
                            <div id="bar-6" class="bg-purple-500 w-1/3 rounded-t transition-all duration-500" style="height: 0%;"></div>
                        </div>
                    </div>
                </div>
            </div>

            <!-- Rubric Container -->
            <div id="rubric-container" class="flex-1 overflow-y-auto p-8 pb-24">
                <!-- Content injected via JS -->
            </div>
        </main>
    </div>

    <!-- DASHBOARD OVERLAY (Full Screen Visualisation) -->
    <div id="dashboard-view" class="hidden fixed inset-0 bg-slate-100 z-20 flex flex-col overflow-y-auto pt-20 pb-10 px-8">
        
        <div class="max-w-7xl mx-auto w-full">
            
            <div class="flex justify-between items-end mb-8">
                <div>
                    <h2 class="text-4xl font-bold text-slate-900 font-serif mb-2">Evaluation Dashboard</h2>
                    <p class="text-slate-500 text-lg">Real-time analysis against Sector-Leading Benchmarks</p>
                </div>
                <div class="flex gap-4">
                    <div class="flex gap-2 print:hidden">
                        <button onclick="window.print()" class="px-4 py-2 bg-slate-800 text-white rounded-lg hover:bg-slate-700 shadow-md transition">
                            <i class="fa-solid fa-print mr-2"></i> Print Dashboard
                        </button>
                    </div>
                    <div class="flex gap-2">
                        <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-amber-100 text-amber-800 text-xs font-bold uppercase">
                            <div class="w-3 h-3 bg-amber-400 rounded-full"></div> Good (L4)
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-blue-100 text-blue-800 text-xs font-bold uppercase">
                            <div class="w-3 h-3 bg-blue-500 rounded-full"></div> Very Good (L5)
                        </div>
                        <div class="flex items-center gap-2 px-3 py-1 rounded-full bg-purple-100 text-purple-800 text-xs font-bold uppercase">
                            <div class="w-3 h-3 bg-purple-600 rounded-full"></div> Excellent (L6)
                        </div>
                    </div>
                </div>
            </div>

            <!-- Cards Grid -->
            <div id="dashboard-grid" class="grid grid-cols-1 md:grid-cols-2 lg:grid-cols-3 gap-6 mb-8">
                <!-- Cards injected via JS -->
            </div>

            <!-- Chart Section -->
            <div class="grid grid-cols-1 lg:grid-cols-3 gap-6 print:break-before-auto">
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 col-span-2 print:col-span-3">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">School Profile (Radar)</h3>
                    <div class="h-80 w-full flex justify-center relative">
                        <canvas id="radarChart"></canvas>
                    </div>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border border-slate-200 print:col-span-3">
                    <h3 class="text-lg font-bold text-slate-800 mb-4">Key Strengths (Level 6)</h3>
                    <ul id="strengths-list" class="space-y-3 text-sm text-slate-600">
                        <li class="text-slate-400 italic">Complete the rubric to see strengths...</li>
                    </ul>
                </div>
            </div>

        </div>
    </div>

    <script>
        // --- Data Structure ---
        const rubricData = {
            "1.3": {
                title: "1.3 Leadership of Change",
                icon: "fa-compass",
                themes: [
                    {
                        name: "Developing a shared vision, values and aims",
                        rows: [
                            { id: "1.3.1.1", focus: "Relevance & Creation", l4: "The school has a clear vision and set of values. Most staff and pupils can articulate them. They were developed in consultation with the community.", l5: "The school has developed a shared vision, values and aims relevant to the school and its community.", l6: "The vision is a unifying force that is lived daily by the whole community. It is authentic, ambitious, and uniquely tailored to the local context." },
                            { id: "1.3.1.2", focus: "Influence & Reach", l4: "The vision and values are displayed and referenced in most departments.", l5: "The vision, values and aims influence the work of every department and faculty.", l6: "The vision is the primary driver for all strategic decisions, resource allocation, and curriculum design across the school." },
                            { id: "1.3.1.3", focus: "Expectations", l4: "Staff generally have high expectations for learners' behaviour and effort.", l5: "High expectations are in place for all learners.", l6: "Senior leaders foster a culture of high professional trust where an exemplary ethos of ambition drives outstanding standards for all." }
                        ]
                    },
                    {
                        name: "Strategic planning for continuous improvement",
                        rows: [
                            { id: "1.3.2.1", focus: "Direction & Data", l4: "The SIP identifies appropriate priorities. Progress is monitored through an annual calendar.", l5: "Senior leaders guide and manage the strategic direction. Planning is evidence-based and linked to effective self-evaluation.", l6: "Strategic planning is underpinned by a culture of professional enquiry. There is a relentless focus on improving outcomes." },
                            { id: "1.3.2.2", focus: "Pace of Change", l4: "The pace of change is generally manageable for most staff.", l5: "Senior leaders ensure the pace of change is appropriate to ensure the desired positive impact for learners.", l6: "Planning is rigorously monitored to ensure the pace of change is ambitious yet sustainable. Leaders manage change expertly to prevent initiative fatigue." },
                            { id: "1.3.2.3", focus: "Resources & Time", l4: "Planning generally takes account of available time and staffing.", l5: "Leaders take good account of the time and resources required to support change.", l6: "Resource planning is innovative and agile, ensuring that the highest priorities receive the most significant investment of time and support." }
                        ]
                    },
                    {
                        name: "Implementing improvement and change",
                        rows: [
                            { id: "1.3.3.1", focus: "Staff Ownership", l4: "Staff are generally willing to engage in change initiatives.", l5: "Staff at all levels take responsibility for implementing change and promoting equity.", l6: "Staff are empowered to lead change. There is a collective ownership of school improvement where every staff member sees themselves as a leader of learning." },
                            { id: "1.3.3.2", focus: "Practitioner Enquiry", l4: "PRD is used to support professional learning. Collaboration exists within departments.", l5: "Collaborative leadership and practitioner enquiry lead to positive change.", l6: "Approaches to change are driven by collaborative practitioner enquiry. Research and data analysis are the default modes of operation." },
                            { id: "1.3.3.3", focus: "Pupil Role in Change", l4: "Pupils are consulted on major changes via the Pupil Council.", l5: "Learners are involved in the process of change and evaluation.", l6: "Young people are strategic partners in school improvement. They co-design policies and learning approaches, providing direct feedback on impact." }
                        ]
                    }
                ]
            },
            "2.2": {
                title: "2.2 Curriculum",
                icon: "fa-map",
                themes: [
                    {
                        name: "Rationale and Design",
                        rows: [
                            { id: "2.2.1.1", focus: "Vision & Rationale", l4: "The curriculum rationale is clear and based on national advice.", l5: "The curriculum has a clear vision and rationale shaped by the shared values of the school.", l6: "The curriculum is a vehicle for empowerment. It is bold, unique, and explicitly designed to realise the school's ambitious vision." },
                            { id: "2.2.1.2", focus: "Entitlements", l4: "The curriculum meets the needs of most learners and covers statutory entitlements.", l5: "It takes account of learners' entitlements and reflects the uniqueness of the setting.", l6: "The curriculum design allows young people to excel in an extensive range of achievements. It balances academic rigour with deep personalisation." }
                        ]
                    },
                    {
                        name: "Learning Pathways",
                        rows: [
                            { id: "2.2.2.1", focus: "Flexibility", l4: "Choices are generally flexible. Pathways allow for attainment in standard measures.", l5: "The curriculum provides flexible learning pathways which lead to raising attainment.", l6: "Pathways are highly personalised and flexible. They are designed to maximise attainment for every individual." },
                            { id: "2.2.2.2", focus: "Progression", l4: "Pathways exist for learners to progress from BGE to Senior Phase. Most find a suitable route.", l5: "Pathways meet the needs and aspirations of all learners and ensure appropriate progression for all.", l6: "Pathways are supported very well by pastoral and curriculum staff. This collaborative support ensures all young people find a route to outstanding attainment." }
                        ]
                    },
                    {
                        name: "Skills for Learning, Life and Work",
                        rows: [
                            { id: "2.2.3.1", focus: "Skill Development", l4: "Skills are mapped across the curriculum. Most young people can talk about skills they are developing.", l5: "There is a clear focus on developing skills (literacy, numeracy, HWB, digital, employability) in a progressive way.", l6: "Young people enhance their skills and confidence to a degree that makes a commendable positive impact on the local community." },
                            { id: "2.2.3.2", focus: "Career Standards", l4: "The school references the Career Education Standard.", l5: "The curriculum has a strong focus on developing the skills young people need for the world of work.", l6: "Skills are demonstrated through 'leading learning'. Young people can articulate their meta-skills clearly to employers." }
                        ]
                    }
                ]
            },
            "2.3": {
                title: "2.3 Learning, Teaching & Assessment",
                icon: "fa-chalkboard-user",
                themes: [
                    {
                        name: "Learning and Engagement",
                        rows: [
                            { id: "2.3.1.1", focus: "Ethos & Rights", l4: "The learning environment is positive. Relationships are good.", l5: "The ethos and culture of the school reflects a commitment to children's rights and positive relationships.", l6: "The outstanding culture and environment for learning supports young people to be empowered partners. Rights are embedded in the fabric of daily interactions." },
                            { id: "2.3.1.2", focus: "Learner Role", l4: "Most learners are engaged. Learners have some opportunities to lead learning.", l5: "Learners are independent, active and contribute effectively to the life of the school.", l6: "Learners take lead roles in their learning experiences. Engagement is intrinsically high, characterized by deep motivation and ownership." },
                            { id: "2.3.1.3", focus: "Student Voice", l4: "Pupils are asked for feedback on lessons.", l5: "Learners are involved in planning and identifying opportunities for personalisation.", l6: "Learners act as partners in pedagogy, co-constructing success criteria and influencing the design of learning experiences." }
                        ]
                    },
                    {
                        name: "Quality of Teaching",
                        rows: [
                            { id: "2.3.2.1", focus: "Approaches & Pace", l4: "Teaching is effective. Explanations are clear.", l5: "Staff use a wide range of learning environments and creative teaching approaches.", l6: "Teachers deliver excellent innovative classroom experiences. Teaching is consistently high-quality across all faculties." },
                            { id: "2.3.2.2", focus: "Differentiation", l4: "Tasks are differentiated for ability groups in most classes.", l5: "Activities are varied, differentiated, and provide effective support and challenge.", l6: "Differentiation is subtle and highly effective. High-attaining learners are stretched, and support for others is seamless and non-stigmatising." },
                            { id: "2.3.2.3", focus: "Digital Technology", l4: "Digital technology is used to support learning where available.", l5: "Learning is enriched and supported by effective use of digital technologies.", l6: "Very strong use of digital technology motivates pupils. Digital tools are used creatively to enhance feedback and independent learning." },
                            { id: "2.3.2.4", focus: "Questioning", l4: "Questioning is used to check understanding.", l5: "Skilled questioning is used to promote curiosity, independence and confidence.", l6: "Approaches to learner conversations are very high quality, consistent, and well-planned. Dialogue pushes learning deeper." }
                        ]
                    },
                    {
                        name: "Effective Use of Assessment",
                        rows: [
                            { id: "2.3.3.1", focus: "Planning", l4: "Assessment is used at the end of units. Staff share learning intentions.", l5: "Assessment is integral to the planning of learning and teaching.", l6: "Assessment is rigorous and fully integrated into 'learner conversations.' It is continuous, diagnostic, and shapes the learning in real-time." },
                            { id: "2.3.3.2", focus: "Variety of Methods", l4: "A mix of formative and summative assessment is used.", l5: "Staff use a variety of assessment approaches to allow learners to demonstrate their learning.", l6: "Assessment methods are innovative and highly personalised, allowing learners to showcase strengths in diverse ways." },
                            { id: "2.3.3.3", focus: "Confidence & Moderation", l4: "Verification ensures standards are generally consistent.", l5: "Staff are highly confident in their professional judgements.", l6: "Assessment data drives an exemplary ethos of ambition. Feedback is high-quality and consistent, empowering pupils to understand exactly how to excel." }
                        ]
                    }
                ]
            },
            "3.1": {
                title: "3.1 Wellbeing, Equality & Inclusion",
                icon: "fa-heart",
                themes: [
                    {
                        name: "Wellbeing",
                        rows: [
                            { id: "3.1.1.1", focus: "Understanding", l4: "Staff know the wellbeing indicators (SHANARRI). Most learners feel safe and cared for.", l5: "The school community has a shared understanding of wellbeing.", l6: "Approaches to wellbeing are sector-leading. Wellbeing is understood as the fundamental driver of attainment and achievement." },
                            { id: "3.1.1.2", focus: "Relationships", l4: "Relationships are positive. Staff deal with wellbeing concerns effectively.", l5: "Relationships are very positive, founded on a climate of mutual respect and shared values.", l6: "Relationships are exemplary. There is a strong sense of belonging and high levels of motivation across the school." },
                            { id: "3.1.1.3", focus: "Pupil Views", l4: "The school has a pupil council and listens to views.", l5: "Children and young people are active participants in discussions and decisions which affect their lives.", l6: "There is an outstanding approach to seeking and acting upon the views of young people." }
                        ]
                    },
                    {
                        name: "Inclusion and Equality",
                        rows: [
                            { id: "3.1.2.1", focus: "Inclusion Impact", l4: "The school celebrates diversity. Support is provided for learners with ASN.", l5: "The school ensures inclusion and equality leads to improved outcomes for all learners.", l6: "The school has an inclusive and ambitious ethos that is recognized as a key strength. Inclusion leads to outstanding levels of attainment for all groups." },
                            { id: "3.1.2.2", focus: "Tackling Barriers", l4: "Incidents of bullying are dealt with. Learners with barriers are identified.", l5: "Barriers to participation are removed. Staff are proactive in promoting positive relationships.", l6: "Staff's focus on fairness for all actively supports those young people most impacted by poverty. Support is seamless." },
                            { id: "3.1.2.3", focus: "Knowledge of Families", l4: "Staff have good information on learner backgrounds.", l5: "Staff consider each child as an individual with their own needs, risks and rights.", l6: "Staff know their families very well. The school works tirelessly to mitigate the impact of socio-economic factors." }
                        ]
                    }
                ]
            },
            "3.2": {
                title: "3.2 Raising Attainment",
                icon: "fa-chart-line",
                themes: [
                    {
                        name: "Attainment in Literacy and Numeracy",
                        rows: [
                            { id: "3.2.1.1", focus: "Progress", l4: "Most learners make good progress from prior levels.", l5: "Learners make very good progress from their prior levels of attainment in literacy and numeracy.", l6: "All young people attain exceptionally well. There are consistently outstanding levels of attainment from S1 to S3 and in National Qualifications." },
                            { id: "3.2.1.2", focus: "Attainment Levels", l4: "Attainment in literacy and numeracy has been raised for most learners.", l5: "Attainment in literacy and numeracy has been raised for all learners.", l6: "Attainment is sector-leading. Young people achieve much better across almost all national measures than learners with similar needs." },
                            { id: "3.2.1.3", focus: "Benchmarks", l4: "Secondary Evidence: In line with national averages/local schools.", l5: "Secondary Evidence: Consistently above Virtual Comparator.", l6: "Secondary Evidence: Significantly positive residuals vs Virtual Comparator across almost all measures." }
                        ]
                    },
                    {
                        name: "Attainment over Time",
                        rows: [
                            { id: "3.2.2.1", focus: "Trends", l4: "Attainment has improved or maintained good standards in most areas.", l5: "Across all curriculum areas attainment has been raised continuously over time and consistently high standards are maintained.", l6: "There is a sustained history of outstanding attainment. The school maintains excellence over time, even during periods of curriculum change." },
                            { id: "3.2.2.2", focus: "Tracking", l4: "Tracking allows staff to identify issues.", l5: "A robust tracking system together with effective interventions ensures continuous progress.", l6: "The school uses sector-leading practice in data utilisation. Staff create skilled interventions that ensure all flourish." }
                        ]
                    },
                    {
                        name: "Overall Quality of Learners' Achievement",
                        rows: [
                            { id: "3.2.3.1", focus: "Confidence & Skills", l4: "Most learners are successful and confident. They achieve a range of skills.", l5: "Overall, learners are successful, confident, exercise responsibility and contribute to the life of the school.", l6: "Young people are highly motivated, articulate, and determined to achieve well. They embrace, achieve and excel in an extensive range of achievements." },
                            { id: "3.2.3.2", focus: "Contribution", l4: "Participation is monitored. Learners contribute to the school community.", l5: "Learners exercise responsibility and contribute to the life of the school.", l6: "Participation is empowering. Young people are empowered partners in their own development, taking full ownership of their achievement pathways." }
                        ]
                    },
                    {
                        name: "Equity for all Learners",
                        rows: [
                            { id: "3.2.4.1", focus: "Systems & Culture", l4: "Systems are in place to promote equity. Attainment has been raised for most learners.", l5: "Effective systems are in place to promote equity. The attainment of all learners has been raised.", l6: "The school has created an inclusive culture of high aspiration. The school has effectively disrupted the link between deprivation and attainment." },
                            { id: "3.2.4.2", focus: "Disadvantaged Learners", l4: "Most learners facing disadvantage make good progress.", l5: "Attainment has been raised in particular for the most disadvantaged.", l6: "The poverty-related attainment gap is negligible. Outcomes for the most disadvantaged are outstanding." },
                            { id: "3.2.4.3", focus: "Destinations", l4: "Most learners move into positive destinations.", l5: "All learners consistently move into sustained positive destinations.", l6: "All young people are supported to excel. Destinations are ambitious, sustained, and reflect the 'exemplary ethos' of the school." }
                        ]
                    }
                ]
            }
        };

        // --- State Management ---
        let currentQI = '2.3';
        let userSelections = {}; 
        let userComments = {}; 
        let isDashboardOpen = false;
        let chartInstance = null;
        const STORAGE_KEY = 'hgios_evaluation_v1';
        const GLOBAL_DATA_VAR = 'HGIOS_SAVED_DATA'; // Variable name in default.js

        // --- Initialization ---
        document.addEventListener('DOMContentLoaded', () => {
            initData();
            loadQI(currentQI);
        });

        function initData() {
            // 1. Check for 'default.js' data (window.HGIOS_SAVED_DATA)
            if (typeof window[GLOBAL_DATA_VAR] !== 'undefined') {
                const defaultData = window[GLOBAL_DATA_VAR];
                if (defaultData && defaultData.selections) {
                    userSelections = defaultData.selections;
                    userComments = defaultData.comments || {};
                    console.log("Loaded configuration from default.js");
                    return; // Stop here, default.js overrides localStorage
                }
            }

            // 2. Fallback to LocalStorage
            loadFromLocal();
        }

        function loadFromLocal() {
            const data = localStorage.getItem(STORAGE_KEY);
            if (data) {
                try {
                    const parsed = JSON.parse(data);
                    userSelections = parsed.selections || {};
                    userComments = parsed.comments || {};
                } catch (e) {
                    console.error("Error loading data", e);
                }
            }
        }

        function saveToLocal() {
            localStorage.setItem(STORAGE_KEY, JSON.stringify({ 
                selections: userSelections, 
                comments: userComments 
            }));
        }

        function loadQI(qiKey) {
            if(isDashboardOpen) toggleDashboard(); 
            
            currentQI = qiKey;
            const qiData = rubricData[qiKey];
            const container = document.getElementById('rubric-container');
            const title = document.getElementById('current-qi-title');

            document.querySelectorAll('.qi-btn').forEach(btn => {
                btn.classList.remove('bg-blue-50', 'border-r-4', 'border-blue-500');
                btn.classList.add('hover:bg-slate-100');
            });
            const activeBtn = document.getElementById(`nav-${qiKey}`);
            if(activeBtn) {
                activeBtn.classList.add('bg-blue-50', 'border-r-4', 'border-blue-500');
                activeBtn.classList.remove('hover:bg-slate-100');
            }

            title.innerText = qiData.title;
            container.innerHTML = '';

            qiData.themes.forEach((theme, themeIndex) => {
                const themeSection = document.createElement('div');
                themeSection.className = "mb-12";
                
                const themeTitle = document.createElement('h3');
                themeTitle.className = "text-lg font-bold text-blue-900 mb-4 border-b pb-2 border-blue-100 uppercase tracking-wide";
                themeTitle.innerText = `Theme ${themeIndex + 1}: ${theme.name}`;
                themeSection.appendChild(themeTitle);

                const table = document.createElement('div');
                table.className = "grid gap-6";

                const header = document.createElement('div');
                header.className = "grid grid-cols-12 gap-4 text-sm font-bold text-slate-500 uppercase tracking-wider mb-2 px-4";
                header.innerHTML = `
                    <div class="col-span-2">Focus Area</div>
                    <div class="col-span-3 text-center">Level 4 (Good)</div>
                    <div class="col-span-3 text-center">Level 5 (Very Good)</div>
                    <div class="col-span-3 text-center text-purple-700">Level 6 (Excellent)</div>
                    <div class="col-span-1 text-center">Evid.</div>
                `;
                table.appendChild(header);

                theme.rows.forEach(row => {
                    const rowEl = document.createElement('div');
                    rowEl.className = "bg-white rounded-lg shadow-sm border border-slate-200 p-4 grid grid-cols-12 gap-4 items-stretch";

                    const label = document.createElement('div');
                    label.className = "col-span-2 flex items-center font-semibold text-slate-700 text-sm pr-2 border-r border-slate-100";
                    label.innerText = row.focus;
                    rowEl.appendChild(label);

                    [4, 5, 6].forEach(level => {
                        const cell = document.createElement('div');
                        cell.className = `col-span-3 p-3 rounded bg-slate-50 text-sm text-slate-600 leading-relaxed cell-interactive hover:bg-white border border-transparent hover:border-blue-200 select-none transition-all`;
                        cell.id = `cell-${row.id}-${level}`;
                        
                        const selection = userSelections[row.id];
                        if (selection && selection.level === level) {
                            if (selection.status === 'secure') cell.classList.add('selected-secure', 'text-green-900');
                            else cell.classList.add('selected-partial', 'text-orange-900');
                        }

                        cell.onclick = () => toggleSelection(row.id, level, cell);
                        cell.innerText = row[`l${level}`];
                        rowEl.appendChild(cell);
                    });

                    const evidBtn = document.createElement('button');
                    evidBtn.className = "col-span-1 flex flex-col items-center justify-center text-slate-400 hover:text-blue-600 transition";
                    evidBtn.title = "Add Evidence / Comments";
                    const hasComment = userComments[row.id] && userComments[row.id].trim().length > 0;
                    evidBtn.innerHTML = `<i class="fa-regular fa-comment-dots text-xl ${hasComment ? 'text-blue-600' : ''}"></i>`;
                    evidBtn.onclick = () => toggleComment(row.id);
                    rowEl.appendChild(evidBtn);

                    const commentBox = document.createElement('div');
                    commentBox.id = `comment-${row.id}`;
                    commentBox.className = `col-span-12 mt-2 ${hasComment ? '' : 'hidden'}`;
                    commentBox.innerHTML = `
                        <label class="block text-xs font-bold text-slate-400 uppercase mb-1">Evidence / Context:</label>
                        <textarea oninput="saveComment('${row.id}', this.value)" class="w-full p-2 text-sm border rounded bg-yellow-50 text-slate-700 focus:ring-2 focus:ring-blue-200 outline-none" rows="2" placeholder="e.g. Evidenced by S3 focus group, May 2025...">${userComments[row.id] || ''}</textarea>
                    `;
                    rowEl.appendChild(commentBox);

                    table.appendChild(rowEl);
                });

                themeSection.appendChild(table);
                container.appendChild(themeSection);
            });

            updateStats();
        }

        function toggleSelection(rowId, level, element) {
            const current = userSelections[rowId];
            
            [4, 5, 6].forEach(l => {
                const el = document.getElementById(`cell-${rowId}-${l}`);
                if (el) el.className = el.className.replace(/selected-secure|selected-partial|text-green-900|text-orange-900/g, '').trim();
            });

            if (current && current.level === level) {
                if (current.status === 'secure') {
                    userSelections[rowId] = { level: level, status: 'partial' };
                    element.classList.add('selected-partial', 'text-orange-900', 'animate-pop');
                } else {
                    delete userSelections[rowId];
                }
            } else {
                userSelections[rowId] = { level: level, status: 'secure' };
                element.classList.add('selected-secure', 'text-green-900', 'animate-pop');
            }
            
            saveToLocal();
            setTimeout(() => element.classList.remove('animate-pop'), 300);
            updateStats();
        }

        function toggleComment(rowId) {
            const box = document.getElementById(`comment-${rowId}`);
            box.classList.toggle('hidden');
            if (!box.classList.contains('hidden')) {
                box.querySelector('textarea').focus();
            }
        }

        function saveComment(rowId, text) {
            userComments[rowId] = text;
            saveToLocal();
        }

        function updateStats() {
            let counts = { 4: 0, 5: 0, 6: 0 };
            let total = 0;

            const currentRows = rubricData[currentQI].themes.flatMap(t => t.rows.map(r => r.id));
            
            currentRows.forEach(id => {
                if (userSelections[id]) {
                    counts[userSelections[id].level] += (userSelections[id].status === 'secure' ? 1 : 0.5);
                    total += 1;
                }
            });

            const max = Math.max(1, total);
            
            document.getElementById('bar-4').style.height = `${(counts[4] / max) * 100}%`;
            document.getElementById('bar-5').style.height = `${(counts[5] / max) * 100}%`;
            document.getElementById('bar-6').style.height = `${(counts[6] / max) * 100}%`;

            Object.keys(rubricData).forEach(qi => {
                const rows = rubricData[qi].themes.flatMap(t => t.rows.map(r => r.id));
                const hasSelection = rows.some(id => userSelections[id]);
                const dot = document.querySelector(`#nav-${qi.replace('.', '\\.')} .status-dot`);
                if(dot) {
                    dot.className = `status-dot w-2 h-2 rounded-full ${hasSelection ? 'bg-blue-500' : 'bg-slate-300 group-hover:bg-slate-400'}`;
                }
            });
        }

        // --- File Load/Save Logic (JavaScript Based) ---

        function saveProfile() {
            const profileData = {
                selections: userSelections,
                comments: userComments,
                timestamp: new Date().toISOString()
            };
            
            // Create valid JS assignment string
            const jsContent = `window.${GLOBAL_DATA_VAR} = ${JSON.stringify(profileData, null, 2)};`;
            
            const dataStr = "data:text/javascript;charset=utf-8," + encodeURIComponent(jsContent);
            const downloadAnchorNode = document.createElement('a');
            downloadAnchorNode.setAttribute("href", dataStr);
            downloadAnchorNode.setAttribute("download", "hgios_data.js");
            document.body.appendChild(downloadAnchorNode);
            downloadAnchorNode.click();
            downloadAnchorNode.remove();
        }

        function triggerLoad() {
            document.getElementById('file-upload').click();
        }

        function handleFileUpload(input) {
            const file = input.files[0];
            if (!file) return;

            const reader = new FileReader();
            reader.onload = function(e) {
                try {
                    const content = e.target.result;
                    let parsedData;

                    // Logic: If it's a JS file, strip the variable declaration. If JSON, parse directly.
                    if (content.trim().startsWith("window." + GLOBAL_DATA_VAR) || content.includes(" = {")) {
                        // Naive strip of "window.VAR = " ... ";"
                        // Finds the first '{' and last '}'
                        const firstBrace = content.indexOf('{');
                        const lastBrace = content.lastIndexOf('}');
                        if (firstBrace !== -1 && lastBrace !== -1) {
                            const jsonPart = content.substring(firstBrace, lastBrace + 1);
                            parsedData = JSON.parse(jsonPart);
                        } else {
                            throw new Error("Could not extract object from JS file.");
                        }
                    } else {
                        // Assume standard JSON
                        parsedData = JSON.parse(content);
                    }

                    if(parsedData && parsedData.selections) {
                        userSelections = parsedData.selections;
                        userComments = parsedData.comments || {};
                        saveToLocal();
                        loadQI(currentQI);
                        if(isDashboardOpen) renderDashboard();
                        alert("Profile loaded successfully!");
                    } else {
                        alert("Invalid file format.");
                    }
                } catch (err) {
                    console.error(err);
                    alert("Error reading file. Ensure it is a valid JSON or JS profile.");
                }
            };
            reader.readAsText(file);
            input.value = '';
        }

        // --- Dashboard Logic ---

        function toggleDashboard() {
            isDashboardOpen = !isDashboardOpen;
            const dash = document.getElementById('dashboard-view');
            const btn = document.getElementById('toggle-btn');
            const body = document.body;
            
            if(isDashboardOpen) {
                dash.classList.remove('hidden');
                btn.innerHTML = '<i class="fa-solid fa-pen-to-square mr-2"></i> Back to Assessment';
                body.classList.add('printing-dashboard');
                renderDashboard();
            } else {
                dash.classList.add('hidden');
                btn.innerHTML = '<i class="fa-solid fa-chart-pie mr-2"></i> Visualise Dashboard';
                body.classList.remove('printing-dashboard');
            }
        }

        function renderDashboard() {
            const grid = document.getElementById('dashboard-grid');
            grid.innerHTML = '';
            const strengthList = document.getElementById('strengths-list');
            strengthList.innerHTML = '';

            let radarLabels = [];
            let radarData = [];
            let hasData = false;

            Object.keys(rubricData).forEach(qiKey => {
                const qi = rubricData[qiKey];
                const allRows = qi.themes.flatMap(t => t.rows);
                const totalPossible = allRows.length;
                
                let weightedSum = 0;
                let countEvaluated = 0;
                
                allRows.forEach(r => {
                    const sel = userSelections[r.id];
                    if(sel) {
                        const weight = sel.status === 'secure' ? 1 : 0.6; 
                        weightedSum += (sel.level * weight);
                        countEvaluated += weight; 
                        
                        if(sel.level === 6 && sel.status === 'secure') {
                            const li = document.createElement('li');
                            li.innerHTML = `<i class="fa-solid fa-check-circle text-purple-600 mr-2"></i> <span class="font-bold text-slate-700">${qiKey}:</span> ${r.focus} (Sector Leading)`;
                            strengthList.appendChild(li);
                        }
                    }
                });

                const average = countEvaluated > 0 ? (weightedSum / countEvaluated) : 0;
                
                let cardClass = "bg-level-0";
                let statusLabel = "Not Started";
                let scoreLabel = "0";
                
                if (countEvaluated > 0) {
                    hasData = true;
                    scoreLabel = average.toFixed(1);
                    if(average >= 5.5) {
                        cardClass = "bg-level-6";
                        statusLabel = "Excellent (6)";
                    } else if (average >= 4.5) {
                        cardClass = "bg-level-5";
                        statusLabel = "Very Good (5)";
                    } else if (average >= 3.5) {
                        cardClass = "bg-level-4";
                        statusLabel = "Good (4)";
                    } else {
                        statusLabel = "Satisfactory (3)";
                    }
                }

                const card = document.createElement('div');
                card.className = `dash-card rounded-xl p-6 border-2 flex flex-col justify-between min-h-[180px] ${cardClass}`;
                card.onclick = () => { toggleDashboard(); loadQI(qiKey); }; 
                card.style.cursor = "pointer";

                card.innerHTML = `
                    <div class="flex justify-between items-start mb-4">
                        <div class="p-3 bg-white rounded-lg shadow-sm text-xl">
                            <i class="fa-solid ${qi.icon}"></i>
                        </div>
                        ${countEvaluated > 0 ? `<span class="text-2xl font-bold opacity-80">${scoreLabel}</span>` : ''}
                    </div>
                    <div>
                        <h4 class="text-lg font-bold mb-1">${qi.title}</h4>
                        <div class="flex justify-between items-center">
                            <span class="text-sm font-semibold uppercase tracking-wide opacity-75">${statusLabel}</span>
                            <span class="text-xs opacity-60">${Math.round(countEvaluated)} / ${totalPossible} areas</span>
                        </div>
                        <div class="w-full bg-white/50 h-1.5 rounded-full mt-3 overflow-hidden">
                            <div class="h-full bg-current opacity-50" style="width: ${(countEvaluated/totalPossible)*100}%"></div>
                        </div>
                    </div>
                `;
                grid.appendChild(card);

                radarLabels.push(qiKey);
                radarData.push(average);
            });

            if(strengthList.innerHTML === '') strengthList.innerHTML = '<li class="text-slate-400 italic">No secure "Excellent" ratings recorded yet.</li>';

            renderChart(radarLabels, radarData);
        }

        function renderChart(labels, data) {
            const ctx = document.getElementById('radarChart').getContext('2d');
            
            if(chartInstance) chartInstance.destroy();

            chartInstance = new Chart(ctx, {
                type: 'radar',
                data: {
                    labels: labels,
                    datasets: [{
                        label: 'Self-Evaluation Profile',
                        data: data,
                        backgroundColor: 'rgba(59, 130, 246, 0.2)',
                        borderColor: 'rgba(59, 130, 246, 1)',
                        borderWidth: 2,
                        pointBackgroundColor: 'rgba(59, 130, 246, 1)',
                    }]
                },
                options: {
                    maintainAspectRatio: false, 
                    scales: {
                        r: {
                            angleLines: { display: true },
                            suggestedMin: 0,
                            suggestedMax: 6,
                            ticks: { stepSize: 1, backdropColor: 'transparent' }, 
                            pointLabels: { font: { size: 11 } } 
                        }
                    },
                    plugins: {
                        legend: { display: false }
                    }
                }
            });
        }

        function resetAll() {
            if(confirm("Reset all selections and comments?")) {
                userSelections = {};
                userComments = {};
                localStorage.removeItem(STORAGE_KEY);
                loadQI(currentQI);
                if(isDashboardOpen) renderDashboard();
            }
        }

    </script>
</body>
</html>
